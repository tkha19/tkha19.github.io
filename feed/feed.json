{
  "version": "https://jsonfeed.org/version/1",
  "title": "Kha&#39;s - Journeys and times of me",
  "home_page_url": "https://lotusirous.github.io/",
  "feed_url": "https://lotusirous.github.io/feed/feed.json",
  "description": "This place is a note for myself",
  "author": {
    "name": "Your Name Here",
    "url": "https://lotusirous.github.io/about-me/"
  },
  "items": [{
      "id": "https://lotusirous.github.io/posts/flask-session/",
      "url": "https://lotusirous.github.io/posts/flask-session/",
      "title": "Default flask session is insecure",
      "content_html": "<p>Let's consider the following deadly simple flask application. The developer stores the secret information in the session key <code>admin_key</code></p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> Flask<span class=\"token punctuation\">,</span> session<br><br>app <span class=\"token operator\">=</span> Flask<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span><br><br><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><br><span class=\"token keyword\">def</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><br>    session<span class=\"token punctuation\">[</span><span class=\"token string\">'admin_key'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'foo-bar'</span><br>    <span class=\"token keyword\">return</span> <span class=\"token string\">\"&lt;p>Hello, World!&lt;/p>\"</span></code></pre>\n<p>Run it:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token assign-left variable\">FLASK_APP</span><span class=\"token operator\">=</span>app.py flask run<br><br> * Serving Flask app <span class=\"token string\">'app.py'</span> <span class=\"token punctuation\">(</span>lazy loading<span class=\"token punctuation\">)</span><br> * Environment: production<br>   WARNING: This is a development server. Do not use it <span class=\"token keyword\">in</span> a production deployment.<br>   Use a production WSGI server instead.<br> * Debug mode: off<br> * Running on http://127.0.0.1:5000/ <span class=\"token punctuation\">(</span>Press CTRL+C to quit<span class=\"token punctuation\">)</span></code></pre>\n<p>Let's parse the server response</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> -ik -vvv http://localhost:5000<br><br>*   Trying <span class=\"token number\">127.0</span>.0.1<span class=\"token punctuation\">..</span>.<br>* TCP_NODELAY <span class=\"token builtin class-name\">set</span><br>* Connected to localhost <span class=\"token punctuation\">(</span><span class=\"token number\">127.0</span>.0.1<span class=\"token punctuation\">)</span> port <span class=\"token number\">5000</span> <span class=\"token punctuation\">(</span><span class=\"token comment\">#0)</span><br><span class=\"token operator\">></span> GET / HTTP/1.1<br><span class=\"token operator\">></span> Host: localhost:5000<br><span class=\"token operator\">></span> User-Agent: curl/7.64.1<br><span class=\"token operator\">></span> Accept: */*<br><span class=\"token operator\">></span><br>* HTTP <span class=\"token number\">1.0</span>, assume close after body<br><span class=\"token operator\">&lt;</span> HTTP/1.0 <span class=\"token number\">200</span> OK<br>HTTP/1.0 <span class=\"token number\">200</span> OK<br><span class=\"token operator\">&lt;</span> Content-Type: text/html<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">charset</span><span class=\"token operator\">=</span>utf-8<br>Content-Type: text/html<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">charset</span><span class=\"token operator\">=</span>utf-8<br><span class=\"token operator\">&lt;</span> Content-Length: <span class=\"token number\">11</span><br>Content-Length: <span class=\"token number\">11</span><br><span class=\"token operator\">&lt;</span> Vary: Cookie<br>Vary: Cookie<br><span class=\"token operator\">&lt;</span> Set-Cookie: <span class=\"token assign-left variable\">session</span><span class=\"token operator\">=</span>eyJhZG1pbl9rZXkiOiJmb28tYmFyIn0.YWv3oA.8ccU4eP_3rOH_zFuiemOieKIw40<span class=\"token punctuation\">;</span> HttpOnly<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/<br>Set-Cookie: <span class=\"token assign-left variable\">session</span><span class=\"token operator\">=</span>eyJhZG1pbl9rZXkiOiJmb28tYmFyIn0.YWv3oA.8ccU4eP_3rOH_zFuiemOieKIw40<span class=\"token punctuation\">;</span> HttpOnly<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/<br><span class=\"token operator\">&lt;</span> Server: Werkzeug/2.0.1 Python/3.8.12<br>Server: Werkzeug/2.0.1 Python/3.8.12<br><span class=\"token operator\">&lt;</span> Date: Sun, <span class=\"token number\">17</span> Oct <span class=\"token number\">2021</span> <span class=\"token number\">10</span>:14:56 GMT<br>Date: Sun, <span class=\"token number\">17</span> Oct <span class=\"token number\">2021</span> <span class=\"token number\">10</span>:14:56 GMT<br><br><span class=\"token operator\">&lt;</span><br>* Closing connection <span class=\"token number\">0</span><br>Hello world</code></pre>\n<p>The <code>Set-Cookie</code> value in HTTP header header is quite interesting for me because it's different from PHP or Java worlds (PHPSESSIONID or JSESSIONID). This value does not look like an id and it's similiar to a JWT token</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">eyJhZG1pbl9rZXkiOiJmb28tYmFyIn0.YWv3oA.8ccU4eP_3rOH_zFuiemOieKIw40</code></pre>\n<p>Let's dive in how the session is implemented.</p>\n",
      "date_published": "2021-10-17T00:00:00Z"
    },{
      "id": "https://lotusirous.github.io/posts/bash-tips/",
      "url": "https://lotusirous.github.io/posts/bash-tips/",
      "title": "Bash tips &amp; tricks",
      "content_html": "<p>While you are doing awesome stuff, some noisy things bother you. The following tips might help you out.</p>\n<h2>Skip the first line from output</h2>\n<p>You want to skip the first line from the output for parsing JSON with jq command.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<br>skip me please<br>{<br>  \"hello\": \"world\"<br>}<br>EOF</span></code></pre>\n<p>You can do it with <code>awk</code> - a utility tool installed in many Linux distributions. It includes a built-in row number variable <code>NR</code> to skip.<br>\nFor example, <code>NR&gt;1</code> is an action to skip a 1 row from the beginning.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">|</span><span class=\"token function\">awk</span> <span class=\"token string\">\"NR>1\"</span> <span class=\"token operator\">|</span>jq</span><br>skip me please<br>{<br>  \"hello\": \"world\"<br>}<br>EOF</span></code></pre>\n<p>Now, the JSON output can be parsed by <code>jq</code></p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span><br>  <span class=\"token property\">\"hello\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"world\"</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>Print all docker images and its tag</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">docker images <span class=\"token operator\">|</span><span class=\"token function\">awk</span> <span class=\"token string\">'NR>1 {print $1\":\"$2}'</span></code></pre>\n<ul>\n<li><code>NR&gt;1</code> skips the output header <code>REPOSITORY:TAG</code> from <code>docker images</code></li>\n<li>Concatenate 2 columns with <code>&quot;:&quot;</code></li>\n</ul>\n",
      "date_published": "2020-06-24T03:52:39Z"
    },{
      "id": "https://lotusirous.github.io/posts/data-mapper-go/",
      "url": "https://lotusirous.github.io/posts/data-mapper-go/",
      "title": "Build a micro ORM in Golang",
      "content_html": "<p>Writing a data access layer is tedious for developers who are not familiar with SQL and the Paradox of Choice of may patterns and libraries<br>\nMany developers usually build up persistent layer with ORM-style by the most-stared library on Github and might end up with unexpected behaviors because some features in the library do over-engineered their requirements.</p>\n<p>The object/relational mapping is a <em>hard</em> problem, essentially what an ORM library is doing is synchronizing between two different representations of data. Many blog posts have been discussing for years by many big authors, such as <a href=\"https://martinfowler.com/bliki/OrmHate.html\">OrmHate</a> by Martin Fowler (not against ORM, but worth mentioning anyway), <a href=\"https://blog.codinghorror.com/object-relational-mapping-is-the-vietnam-of-computer-science/\">Object-Relational Mapping Is the Vietnam of Computer Science</a> by Jeff Atwood, The Vietnam of Computer Science by Ted Neward, ORM Is an Anti-Pattern by Laurie Voss, and many others.</p>\n<p>Starting your baby steps with a simple data mapper makes code base clean, simple and maintainable. In this tutorial, I will show you the steps to build a micro data mapper was taken from <a href=\"https://github.com/drone/drone\">drone</a> - a elegant go project structure.</p>\n<h2>The design of data mapper</h2>\n<p>Before jump into the implementation detail, let's summarize the definition of data mapper.</p>\n<blockquote>\n<p>Data mapper is a layer of mappers that moves data between objects and a database while keeping them independent of each other and the mapper itself.</p>\n</blockquote>\n<p>A data mapper is a interface of an object that operate the represent domain entity types in a data store. It contains 3 main parts: an object, a mapper and a database connection.<br>\nA <code>User</code> is grouped by a <code>UserStore</code> interface to perform data access actions on data store. <code>UserStore</code> defines domain logic to manipulate the data from data store. Each action contains a mapper to move data between application objects and database. <code>Create</code> method have a mapper to translate a object to <code>CREATE</code> SQL statement with a pair field-column in the table. Finally, the database connection is initialized and injected by dependency injection to an implemented object.</p>\n<p>The following <code>User</code> struct contains 7 properties: login (<code>login</code>), active (<code>active</code>), showing (<code>avatar</code>) and tracking (<code>created, updated, lastLogin</code>). A tricky type <code>int64</code> is using for tracking properties to store timestamp because timestamp not only removes a couple between time and server time zone compare to parsing <code>string</code> format but also does not depends on timezone.</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// User represents a user of the system.</span><br><span class=\"token keyword\">type</span> User <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span><br>  Login     <span class=\"token builtin\">string</span><br>  Email     <span class=\"token builtin\">string</span><br>  Avatar    <span class=\"token builtin\">string</span><br>  Active    <span class=\"token builtin\">bool</span><br>  LastLogin <span class=\"token builtin\">int64</span><br>  Created   <span class=\"token builtin\">int64</span><br>  Updated   <span class=\"token builtin\">int64</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>The <code>UserStore</code> methods are divided into commands (<code>Create, Update, Delete</code>) and queries (<code>Find, List, FindLogin, FindActive, Count</code>) for write/read operations respectively. The command group changes the state of <code>User</code> object while queries group only read the <code>User</code> object.</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// UserStore defines operations for working with users.</span><br><span class=\"token keyword\">type</span> UserStore <span class=\"token keyword\">interface</span> <span class=\"token punctuation\">{</span><br><br>  <span class=\"token comment\">// Create persists a new user to the datastore.</span><br>  <span class=\"token function\">Create</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>User<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span><br><br>  <span class=\"token comment\">// Update persists an updated user to the datastore.</span><br>  <span class=\"token function\">Update</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>User<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span><br><br>  <span class=\"token comment\">// Delete deletes a user from the datastore.</span><br>  <span class=\"token function\">Delete</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>User<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span><br><br>  <span class=\"token comment\">// Find returns a user from the data store.</span><br>  <span class=\"token function\">Find</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> <span class=\"token builtin\">int64</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>User<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span><br><br>  <span class=\"token comment\">// List returns a list of users from the datastore.</span><br>  <span class=\"token function\">List</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span>User<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span><br><br>  <span class=\"token comment\">// FindLogin returns a user from the datastore by username.</span><br>  <span class=\"token function\">FindLogin</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>User<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span><br><br>  <span class=\"token comment\">// FindActive returns a list of active users from the datastore.</span><br>  <span class=\"token function\">FindActive</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span>User<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span><br><br>  <span class=\"token comment\">// Count returns a count of users.</span><br>  <span class=\"token function\">Count</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">int64</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>I use <code>context.Context</code> as a first parameter for each method to carries deadlines, cancellation signals, and other request-scoped values.</p>\n<h2>Database connection</h2>\n<p>Although the built-in library <code>database/sql</code> provides a generic sql driver, it does not provides naming query statement and binding execution which provided by a <code>sqlx</code>. A common <code>Locker</code> interface to lock and unlock a share resource (SQLite for testing) and distinguish driver type with <code>driver</code>.</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// Driver defines the database driver.</span><br><span class=\"token keyword\">type</span> Driver <span class=\"token builtin\">int</span><br><br><span class=\"token comment\">// Database driver enums.</span><br><span class=\"token keyword\">const</span> <span class=\"token punctuation\">(</span><br>  Sqlite <span class=\"token operator\">=</span> <span class=\"token boolean\">iota</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><br>  Mysql<br>  Postgres<br><span class=\"token punctuation\">)</span><br><br><span class=\"token comment\">// DB is a pool of zero or more underlying connections to</span><br><span class=\"token comment\">// the database.</span><br><span class=\"token keyword\">type</span> DB <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span><br>  conn   <span class=\"token operator\">*</span>sqlx<span class=\"token punctuation\">.</span>DB<br>  lock   Locker<br>  driver Driver<br><span class=\"token punctuation\">}</span><br><br><span class=\"token comment\">// A Locker represents an object that can be locked and unlocked.</span><br><span class=\"token keyword\">type</span> Locker <span class=\"token keyword\">interface</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>  <span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>  <span class=\"token function\">RLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>  <span class=\"token function\">RUnlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>The pattern <strong>commands</strong> and <strong>queries</strong> is implemented by <code>Queryer</code>, <code>Binder</code> and <code>Execer</code> helper interfaces.  <code>Binder</code> maps parameters to build a query while <code>Queryer</code> reads a row in database to return a <code>sql.Row</code> and the <code>Execer</code> performs an execution with a given query.</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">type</span> <span class=\"token punctuation\">(</span><br>  <span class=\"token comment\">// Queryer interface defines a set of methods for</span><br>  <span class=\"token comment\">// querying the database.</span><br>  Queryer <span class=\"token keyword\">interface</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token function\">Query</span><span class=\"token punctuation\">(</span>query <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> args <span class=\"token operator\">...</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>sql<span class=\"token punctuation\">.</span>Rows<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span><br>    <span class=\"token function\">QueryRow</span><span class=\"token punctuation\">(</span>query <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> args <span class=\"token operator\">...</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>sql<span class=\"token punctuation\">.</span>Row<br>  <span class=\"token punctuation\">}</span><br><br>  <span class=\"token comment\">// Binder interface defines database field bindings.</span><br>  Binder <span class=\"token keyword\">interface</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token function\">BindNamed</span><span class=\"token punctuation\">(</span>query <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> arg <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span><br>  <span class=\"token punctuation\">}</span><br><br>  <span class=\"token comment\">// Execer interface defines a set of methods for executing</span><br>  <span class=\"token comment\">// read and write commands against the database.</span><br>  Execer <span class=\"token keyword\">interface</span> <span class=\"token punctuation\">{</span><br>    Queryer<br>    <span class=\"token function\">Exec</span><span class=\"token punctuation\">(</span>query <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> args <span class=\"token operator\">...</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">.</span>Result<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">)</span></code></pre>\n<p><code>View</code> and <code>Lock</code> wraps a read/write to database in a safe action with desired lock.</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// View executes a function within the context of a managed read-only</span><br><span class=\"token comment\">// transaction. Any error that is returned from the function is returned</span><br><span class=\"token comment\">// from the View() method.</span><br><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>db <span class=\"token operator\">*</span>DB<span class=\"token punctuation\">)</span> <span class=\"token function\">View</span><span class=\"token punctuation\">(</span>fn <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>Queryer<span class=\"token punctuation\">,</span> Binder<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span><br>  db<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">RLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>  err <span class=\"token operator\">:=</span> <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>db<span class=\"token punctuation\">.</span>conn<span class=\"token punctuation\">,</span> db<span class=\"token punctuation\">.</span>conn<span class=\"token punctuation\">)</span><br>  db<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">RUnlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>  <span class=\"token keyword\">return</span> err<br><span class=\"token punctuation\">}</span><br><br><span class=\"token comment\">// Lock obtains a write lock to the database (sqlite only) and executes</span><br><span class=\"token comment\">// a function. Any error that is returned from the function is returned</span><br><span class=\"token comment\">// from the Lock() method.</span><br><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>db <span class=\"token operator\">*</span>DB<span class=\"token punctuation\">)</span> <span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span>fn <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>Execer<span class=\"token punctuation\">,</span> Binder<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span><br>  db<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>  err <span class=\"token operator\">:=</span> <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>db<span class=\"token punctuation\">.</span>conn<span class=\"token punctuation\">,</span> db<span class=\"token punctuation\">.</span>conn<span class=\"token punctuation\">)</span><br>  db<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>  <span class=\"token keyword\">return</span> err<br><span class=\"token punctuation\">}</span></code></pre>\n<p>The <code>Update</code> action requires rollback a executed action when error happened.<br>\nA tricky <code>defer</code> wraps <code>recover</code> and <code>commit</code> to support atomic transaction.</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// Update executes a function within the context of a read-write managed</span><br><span class=\"token comment\">// transaction. If no error is returned from the function then the</span><br><span class=\"token comment\">// transaction is committed. If an error is returned then the entire</span><br><span class=\"token comment\">// transaction is rolled back. Any error that is returned from the function</span><br><span class=\"token comment\">// or returned from the commit is returned from the Update() method.</span><br><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>db <span class=\"token operator\">*</span>DB<span class=\"token punctuation\">)</span> <span class=\"token function\">Update</span><span class=\"token punctuation\">(</span>fn <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>Execer<span class=\"token punctuation\">,</span> Binder<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>err <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  db<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>  <span class=\"token keyword\">defer</span> db<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><br>  tx<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> db<span class=\"token punctuation\">.</span>conn<span class=\"token punctuation\">.</span><span class=\"token function\">Begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>  <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">return</span> err<br>  <span class=\"token punctuation\">}</span><br><br>  <span class=\"token keyword\">defer</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">if</span> p <span class=\"token operator\">:=</span> <span class=\"token function\">recover</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> p <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>      err <span class=\"token operator\">=</span> tx<span class=\"token punctuation\">.</span><span class=\"token function\">Rollback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>      debug<span class=\"token punctuation\">.</span><span class=\"token function\">PrintStack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>      tx<span class=\"token punctuation\">.</span><span class=\"token function\">Rollback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>      err <span class=\"token operator\">=</span> tx<span class=\"token punctuation\">.</span><span class=\"token function\">Commit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><br>  err <span class=\"token operator\">=</span> <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">,</span> db<span class=\"token punctuation\">.</span>conn<span class=\"token punctuation\">)</span><br>  <span class=\"token keyword\">return</span> err<br><span class=\"token punctuation\">}</span></code></pre>\n<h2>The mapper detail</h2>\n<p>The declaration of <code>queryBase</code> is using for mapping fields. Since the result reads fields from <code>SELECT</code> statement, it shares the mapping with the child queries. For example, the <code>queryKey</code> is our domain logic to find a user by a given id. The usage of  <code>SELECT * FROM users</code> is not clear which fields is returned from database in order to guaranty the fields order and data types.</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">const</span> queryBase <span class=\"token operator\">=</span> <span class=\"token string\">`<br>SELECT<br>user_id,<br>user_login,<br>user_email,<br>user_avatar,<br>user_active,<br>user_last_login,<br>user_created,<br>user_updated,<br>`</span><br><br><span class=\"token keyword\">const</span> queryKey <span class=\"token operator\">=</span> queryBase <span class=\"token operator\">+</span> <span class=\"token string\">`<br>FROM users<br>WHERE user_id = :user_id<br>`</span></code></pre>\n<p>We do fields mapping as follows:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><br><span class=\"token comment\">// helper function converts the User structure to a set</span><br><span class=\"token comment\">// of named query parameters.</span><br><span class=\"token keyword\">func</span> <span class=\"token function\">toParams</span><span class=\"token punctuation\">(</span>u <span class=\"token operator\">*</span>core<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">)</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span><br>    <span class=\"token string\">\"user_id\"</span><span class=\"token punctuation\">:</span>         u<span class=\"token punctuation\">.</span>ID<span class=\"token punctuation\">,</span><br>    <span class=\"token string\">\"user_login\"</span><span class=\"token punctuation\">:</span>      u<span class=\"token punctuation\">.</span>Login<span class=\"token punctuation\">,</span><br>    <span class=\"token string\">\"user_email\"</span><span class=\"token punctuation\">:</span>      u<span class=\"token punctuation\">.</span>Email<span class=\"token punctuation\">,</span><br>    <span class=\"token string\">\"user_avatar\"</span><span class=\"token punctuation\">:</span>     u<span class=\"token punctuation\">.</span>Avatar<span class=\"token punctuation\">,</span><br>    <span class=\"token string\">\"user_active\"</span><span class=\"token punctuation\">:</span>     u<span class=\"token punctuation\">.</span>Active<span class=\"token punctuation\">,</span><br>    <span class=\"token string\">\"user_last_login\"</span><span class=\"token punctuation\">:</span> u<span class=\"token punctuation\">.</span>LastLogin<span class=\"token punctuation\">,</span><br>    <span class=\"token string\">\"user_created\"</span><span class=\"token punctuation\">:</span>    u<span class=\"token punctuation\">.</span>Created<span class=\"token punctuation\">,</span><br>    <span class=\"token string\">\"user_updated\"</span><span class=\"token punctuation\">:</span>    u<span class=\"token punctuation\">.</span>Updated<span class=\"token punctuation\">,</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token comment\">// helper function scans the sql.Row and copies the column</span><br><span class=\"token comment\">// values to the destination object.</span><br><span class=\"token keyword\">func</span> <span class=\"token function\">scanRow</span><span class=\"token punctuation\">(</span>scanner db<span class=\"token punctuation\">.</span>Scanner<span class=\"token punctuation\">,</span> dest <span class=\"token operator\">*</span>core<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">return</span> scanner<span class=\"token punctuation\">.</span><span class=\"token function\">Scan</span><span class=\"token punctuation\">(</span><br>    <span class=\"token operator\">&amp;</span>dest<span class=\"token punctuation\">.</span>Login<span class=\"token punctuation\">,</span><br>    <span class=\"token operator\">&amp;</span>dest<span class=\"token punctuation\">.</span>Email<span class=\"token punctuation\">,</span><br>    <span class=\"token operator\">&amp;</span>dest<span class=\"token punctuation\">.</span>Avatar<span class=\"token punctuation\">,</span><br>    <span class=\"token operator\">&amp;</span>dest<span class=\"token punctuation\">.</span>Active<span class=\"token punctuation\">,</span><br>    <span class=\"token operator\">&amp;</span>dest<span class=\"token punctuation\">.</span>LastLogin<span class=\"token punctuation\">,</span><br>    <span class=\"token operator\">&amp;</span>dest<span class=\"token punctuation\">.</span>Created<span class=\"token punctuation\">,</span><br>    <span class=\"token operator\">&amp;</span>dest<span class=\"token punctuation\">.</span>Updated<span class=\"token punctuation\">,</span><br>  <span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>The usage of  <code>interface{}</code> gives a generic type to map each field in <code>User</code> struct to map with a field in a record from SQL table. However, a drawback of type checking by compiler when compiling the mapper. We can overcome this issue with a wring a unit test.</p>\n<p>If we have many SQL statements, we can take advantage of finding similar word by editors (<code>cmd + d</code> in sublime text for example)</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// Find returns a user from the datastore.</span><br><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">*</span>userStore<span class=\"token punctuation\">)</span> <span class=\"token function\">Find</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> id <span class=\"token builtin\">int64</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>core<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  out <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>core<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">{</span>ID<span class=\"token punctuation\">:</span> id<span class=\"token punctuation\">}</span><br>  err <span class=\"token operator\">:=</span> s<span class=\"token punctuation\">.</span>db<span class=\"token punctuation\">.</span><span class=\"token function\">View</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>queryer db<span class=\"token punctuation\">.</span>Queryer<span class=\"token punctuation\">,</span> binder db<span class=\"token punctuation\">.</span>Binder<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span><br>    params <span class=\"token operator\">:=</span> <span class=\"token function\">toParams</span><span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span><br>    query<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> binder<span class=\"token punctuation\">.</span><span class=\"token function\">BindNamed</span><span class=\"token punctuation\">(</span>queryKey<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token keyword\">return</span> err<br>    <span class=\"token punctuation\">}</span><br>    row <span class=\"token operator\">:=</span> queryer<span class=\"token punctuation\">.</span><span class=\"token function\">QueryRow</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span> args<span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">return</span> <span class=\"token function\">scanRow</span><span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">,</span> out<span class=\"token punctuation\">)</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br>  <span class=\"token keyword\">return</span> out<span class=\"token punctuation\">,</span> err<br><span class=\"token punctuation\">}</span></code></pre>\n<h2>Wrap-up</h2>\n<p>I have illustrated the baby step to create a micro ORM for mapping <code>User</code> data. The pattern approach provides a just enough technique for solving problems. The more detail can be found on <a href=\"https://github.com/lotusirous/realworld\">Github</a> with an implemented <a href=\"https://github.com/gothinkster/realworld\">real world application</a>.</p>\n<p>I hope this article will help you figure out how to design a good code in Go when working with SQL databases.</p>\n",
      "date_published": "2019-08-18T03:50:37Z"
    },{
      "id": "https://lotusirous.github.io/posts/update-docker/",
      "url": "https://lotusirous.github.io/posts/update-docker/",
      "title": "Update all docker images",
      "content_html": "<p>Docker does not have a command to update your images to latest version that you have already pulled in your system by default. Sometimes, we want to update image to latest version because of bugs or vulnerabilities. This action is similar to <code>apt update &amp;&amp; apt upgrade</code> in debian-based system.</p>\n<p>The following one-line command can help you update all images at with its tags.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">docker images <span class=\"token operator\">|</span><span class=\"token function\">tail</span> -n +2 <span class=\"token operator\">|</span><span class=\"token function\">awk</span> <span class=\"token string\">'{t=$1\":\"$2; print t}'</span> <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> -L1 docker pull</code></pre>\n",
      "date_published": "2019-08-01T01:37:30Z"
    },{
      "id": "https://lotusirous.github.io/posts/pretty-json-inside-vim/",
      "url": "https://lotusirous.github.io/posts/pretty-json-inside-vim/",
      "title": "Pretty JSON inside Vim",
      "content_html": "<p>After installing <a href=\"https://github.com/stedolan/jq\">jq</a>, it's pretty straightforward</p>\n<!--more-->\n<pre class=\"language-bash\"><code class=\"language-bash\">%<span class=\"token operator\">!</span>jq <span class=\"token string\">'.'</span></code></pre>\n",
      "date_published": "2018-01-20T00:50:39Z"
    },{
      "id": "https://lotusirous.github.io/posts/offline-install-tips/",
      "url": "https://lotusirous.github.io/posts/offline-install-tips/",
      "title": "Install packages offline on RHEL-based distribution",
      "content_html": "<p>This post shows contains some notes to install packages on RHEL server.</p>\n<!--more-->\n<h2>Download and install packages for RHEL distribution</h2>\n<p>Before downloading packages, you need to check the pre-installed packages and OS version (including minor version). The OS on target machine might use <a href=\"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/installation_guide/sn-automating-installation\">automate installation with kickstart</a> method by default. Thus, you can replicate the environment by downloading the same OS version and selecting the pre-installed packages in <a href=\"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/installation_guide/sect-package-selection-x86\">software selection step</a> from the file <code>/root/anaconda-ks.cfg</code>. For example, the target OS used <em>minimal</em> install base environment and <code>kexec-tools</code>.</p>\n<pre class=\"language-text\"><code class=\"language-text\">%packages<br>@^minimal<br>@core<br>kexec-tools</code></pre>\n<p>Then, you can download required packages with the following command</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">yum <span class=\"token function\">install</span> --downloadonly --downloaddir<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>directory<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>package<span class=\"token operator\">></span><br>yum --disablerepo<span class=\"token operator\">=</span>* localinstall *.rpm</code></pre>\n<h2>Install python package from local</h2>\n<p>The following command installs <code>keras</code> package from local</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">pip <span class=\"token function\">install</span> --no-index --find-links <span class=\"token builtin class-name\">.</span> keras</code></pre>\n",
      "date_published": "2017-01-14T14:04:37Z"
    }
  ]
}
